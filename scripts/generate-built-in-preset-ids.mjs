import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const packageRoot = path.resolve(scriptDir, "..");
const presetsFile = path.resolve(packageRoot, "src", "data", "tweakcn-presets.ts");
const outFile = path.resolve(packageRoot, "src", "data", "built-in-preset-ids.ts");

function findObjectLiteralSource(source, marker) {
  const markerIndex = source.indexOf(marker);
  if (markerIndex === -1) {
    throw new Error(`Marker not found: ${marker}`);
  }

  const braceStart = source.indexOf("{", markerIndex);
  if (braceStart === -1) {
    throw new Error(`Object literal start '{' not found after marker: ${marker}`);
  }

  let depth = 0;
  let inString = false;
  let stringQuote = null;
  let isEscaped = false;

  for (let index = braceStart; index < source.length; index++) {
    const char = source[index];

    if (inString) {
      if (isEscaped) {
        isEscaped = false;
        continue;
      }
      if (char === "\\") {
        isEscaped = true;
        continue;
      }
      if (char === stringQuote) {
        inString = false;
        stringQuote = null;
      }
      continue;
    }

    if (char === '"' || char === "'") {
      inString = true;
      stringQuote = char;
      continue;
    }

    if (char === "{") depth++;
    if (char === "}") depth--;

    if (depth === 0) {
      return source.slice(braceStart, index + 1);
    }
  }

  throw new Error(`Failed to find end of object literal for marker: ${marker}`);
}

function main() {
  const source = fs.readFileSync(presetsFile, "utf8");
  const objectLiteral = findObjectLiteralSource(source, "export const tweakcnPresets");

  const ids = [];
  const seen = new Set();
  const idRegex = /^  "([^"]+)": \{/gm;
  let match;

  while ((match = idRegex.exec(objectLiteral)) !== null) {
    const id = match[1];
    if (!seen.has(id)) {
      seen.add(id);
      ids.push(id);
    }
  }

  if (ids.length === 0) {
    throw new Error("No preset IDs found. Generator regex likely needs updating.");
  }

  ids.sort();

  const output =
    `// This file is auto-generated by scripts/generate-built-in-preset-ids.mjs\n` +
    `// Do not edit manually.\n\n` +
    `export const builtInPresetIds = [\n` +
    ids.map((id) => `  "${id}",\n`).join("") +
    `] as const;\n\n` +
    `export type BuiltInPresetId = (typeof builtInPresetIds)[number];\n`;

  fs.mkdirSync(path.dirname(outFile), { recursive: true });
  fs.writeFileSync(outFile, output, "utf8");
}

main();
